<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <title>Probe Request Collector's Kit</title>
  <link rel="stylesheet" type="text/css" href="css/styles.css">
  <link rel="stylesheet" href="css/ol.css" type="text/css">


</head>

<body>

  <pre id="networks"></pre>
  <div id="map" class="map"></div>

  <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
  <script src="js/ol.js"></script>
  <!-- // <script src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script> -->
  <script src="js/tile.stamen.js"></script>
  <script type="text/javascript">

    // via http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }
    
    // ------------------------------------------------------------------------------- get networks
    $.ajax({
      url: 'http://localhost:3000/api/networks?device='+getParameterByName('mac'),
      method: 'GET',
      success: onNetworksResponse,
      error: function(err){
        console.log(err);
      }
    });
    function onNetworksResponse(data){
      console.log( "networks", data );
      getGPS( data );
    }

    // ------------------------------------------------------------------------------- get GPS 
    function getGPS( networks ){
      var data = {
        ssid: networks,
        collection: "wigleChicago"
      }

      $.ajax({
        url: 'http://localhost:3000/api/wigle',
        method: 'GET',
        data: data,
        success: onGPSResponse,
        error: function(err){
          console.log(err);
        }
      });
      
      function onGPSResponse(data){
        if (!data.error) {
          var results = data.results;
          for (var i = 0; i < results.length; i++) {
            var network = results[i];
            gps_vectors.push({ssid:network.ssid, lat:network.geo.lat, lon:network.geo.lon});
          }
          // draw butterflies to map!!
          console.log("gps data", gps_vectors)
          var butterflies = addButterflies();
          map.addLayer( butterflies );
        } else {
          console.log(data);
        }
      } 
    }
    


    // maps -------------------------------------------------------------------------------
    
    var chicago = ol.proj.transform([-87.625088,41.879528], 'EPSG:4326', 'EPSG:3857');
    var vectorSource = new ol.source.Vector({}); // empty vector
    var gps_vectors = []; // aray of objects of butterfly vectors
    var markers = []; // empty markers for when i do lines later TO-DO
    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({source: new ol.source.Stamen({layer: 'toner'})})
        ],
        view: new ol.View({ center: chicago, zoom: 13 })
    });


    function addButterflies() {
      // vectors
      for (var i=0;i<gps_vectors.length-1;i++){
        var x = gps_vectors[i].lon;
        var y = gps_vectors[i].lat;
        var iconFeature = new ol.Feature({
              geometry: new ol.geom.Point(ol.proj.transform([x,y], 'EPSG:4326','EPSG:3857')),
              name: gps_vectors[i].ssid
          });
        vectorSource.addFeature(iconFeature);
        markers[i]= ol.proj.transform([x,y], 'EPSG:4326',   'EPSG:3857');
      }

      // style
      var iconStyle = new ol.style.Style({
        image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
            anchor: [0.5,0.5],
            anchorXUnits: 'fraction', // or pixels
            anchorYUnits: 'fraction', // or pixels
            opacity: 0.75,
            src: 'images/butterfly.png'
        }))
      });

      // add the feature vector to the layer vector, and apply a style to whole layer
      var vectorLayer = new ol.layer.Vector({
          source: vectorSource,
          style: iconStyle
      });
      return vectorLayer;
    }
      
  



  </script>

</body>
</html>
