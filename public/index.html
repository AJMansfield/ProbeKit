<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Butteryfly Test</title>

  <!-- <link rel="stylesheet" href="css/styles.css"> -->
</head>

<body>

  <pre id="dump"></pre>
  <script src="js/jquery-1.11.2.min.js"></script>
  <script src="js/underscore-1.8.2.min.js"></script>
  <script src="js/moment-min.2.9.0.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
  		
  		$(document).ready(function(){
  
  			var probeData = {
  				numMacs: 0,
  				macs: {}
  			};
  			var rawCSV = undefined;
  			
  			$.ajax({
			  	url: "data/probes.csv",
			  	success: function(data) {
				  rawCSV = data;
				  parseCSVToProbeData();
			  	},
			  	error: function(err){
			  		throw err;
			  	}
			});

			var socket = io.connect("http://" + window.location.host);
			socket.on('probeReceived', function (probe) {
			    // add the probe to our master probeData object
			    addProbe(probe.mac, probe.ssid, probe.timestamp);
			});

			function parseCSVToProbeData() {

				if (rawCSV != undefined) {
					var lines = rawCSV.split('\n');
					for (var i = 0; i < lines.length; i++) {
						var probe = lines[i].split(',');
						if (probe.length == 3) {
							addProbe(probe[0], probe[1], probe[2]);
						}
					}
				}
			}

			function addProbe(mac, ssid, timestamp) {
				
				if (!probeData.macs.hasOwnProperty(mac)) {
					probeData.macs[mac] = {};
					probeData.macs[mac].knownNetworks = [];
					probeData.macs[mac].lastSeen = 0;
					probeData.macs[mac].timesSeen = 0;
					probeData.numMacs++;
				}

				probeData.macs[mac].lastSeen = timestamp;
				probeData.macs[mac].timesSeen++;
				if (probeData.macs[mac].knownNetworks.indexOf(ssid) == -1) {
					probeData.macs[mac].knownNetworks.push(ssid);
				}

				onProbeAdded(mac, ssid, timestamp);
			}

			function onProbeAdded(mac, ssid, timestamp) {
				var time = moment(parseInt(timestamp)).format('YYYY-MM-DD HH:mm:ss');
				$('#dump').prepend(time + '    MAC: ' + mac + '    SSID: ' + ssid + '\n');
			}

  		});
  </script>
</body>
</html>